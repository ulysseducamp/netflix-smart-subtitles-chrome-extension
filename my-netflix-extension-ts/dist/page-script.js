(()=>{"use strict";!function(){console.log("Netflix Subtitle Downloader: Page script loaded - starting JSON hijacking immediately");const e="webvtt-lssdh-ios8",n="netflix-subtitle-track",t="netflix-custom-subs",o=["heaac-2-dash","heaac-2hq-dash","playready-h264mpl30-dash","playready-h264mpl31-dash","playready-h264hpl30-dash","playready-h264hpl31-dash","vp9-profile0-L30-dash-cenc","vp9-profile0-L31-dash-cenc","dfxp-ls-sdh","simplesdh","nflx-cmisc","BIF240","BIF320"],i=new Map,l=new Map;let a=null,r=null,s=null,c=!0;function d(e){for(const n in e){const t=e[n];if(Array.isArray(t)&&("profiles"===n||t.some(e=>o.includes(e))))return t;if("object"==typeof t&&null!==t){const e=d(t);if(e)return e}}return null}function u(n){const t=n.movieId;console.log("Netflix Subtitle Downloader: Extracting tracks for movie ID:",t);const o=[];if(n.timedtexttracks){console.log("Netflix Subtitle Downloader: Found timedtexttracks:",n.timedtexttracks);for(const t of n.timedtexttracks){if(console.log("Netflix Subtitle Downloader: Processing track:",t.language),t.isForcedNarrative||t.isNoneTrack){console.log("Netflix Subtitle Downloader: Skipping forced/none track");continue}if(!t.ttDownloadables){console.log("Netflix Subtitle Downloader: No ttDownloadables found");continue}const n=t.ttDownloadables[e];if(console.log("Netflix Subtitle Downloader: WebVTT downloadable:",n),!n||!n.urls){console.log("Netflix Subtitle Downloader: No WebVTT URLs found");continue}const i=n.urls[0].url;if(!i){console.log("Netflix Subtitle Downloader: No valid URL found");continue}const l="closedcaptions"===t.rawTrackType;o.push({id:t.new_track_id,language:t.language,languageDescription:t.languageDescription,bestUrl:i,isClosedCaptions:l})}console.log("Netflix Subtitle Downloader: Caching movie tracks:",t,o),i.set(t,o),x({type:"NETFLIX_SUBTITLES",action:"TRACKS_AVAILABLE",data:{movieId:t,tracks:o}}),console.log("Netflix Subtitle Downloader: Triggering subtitle injection after track discovery"),b()}else console.log("Netflix Subtitle Downloader: No timedtexttracks found")}const f=RegExp("</?([^>]*)>","ig");function m(e,n=!0){let t=e;if(t=t.replace(f,function(e,n){return["i","u","b"].includes(n.toLowerCase())?e:""}),n){const e=t.split("\n"),n=[];for(const t of e)t.startsWith("&lrm;")?n.push("‪"+t.slice(5)+"‬"):t.startsWith("&rlm;")?n.push("‫"+t.slice(5)+"‬"):n.push(t);t=n.join("\n")}return t}function p(e){const n=new Date(0,0,0,0,0,0,1e3*e);return n.getHours().toString().padStart(2,"0")+":"+n.getMinutes().toString().padStart(2,"0")+":"+n.getSeconds().toString().padStart(2,"0")+","+n.getMilliseconds().toString().padStart(3,"0")}function x(e){window.postMessage(e,"*")}function g(){console.log("Netflix Subtitle Downloader: Removing track element and overlay");const e=document.getElementById(n);e&&e.remove();const o=document.getElementById(t);o&&o.remove()}function b(){const e=document.querySelector("video");if(e&&a){const o=function(){const e=function(){const e='1\n00:00:56,916 --\x3e 00:00:59,541\nO mundo era mais bonito\nna sua cabeça, pai.\n\n2\n00:01:13,833 --\x3e 00:01:17,750\nCEM ANOS DE SOLIDÃO\n\n3\n00:01:28,333 --\x3e 00:01:31,958\n<i>Il avait fait le tour du monde 65 fois,</i>\n\n4\n00:01:33,250 --\x3e 00:01:36,583\n<i>enrôlé dans un équipage</i>\n<i>de marins apatrides.</i>\n\n5\n00:01:37,625 --\x3e 00:01:38,958\n<i>Havia naufragado</i>\n\n6\n00:01:39,583 --\x3e 00:01:43,250\n<i>et avait dérivé pendant deux semaines</i>\n<i>dans la mer du Japon.</i>\n\n7\n00:01:44,833 --\x3e 00:01:46,833\nOn a perdu le navire dans une tempête.\n\n8\n00:01:47,791 --\x3e 00:01:52,000\nOn est restés à la dérive\npendant des jours, moi et un autre marin,\n\n9\n00:01:53,000 --\x3e 00:01:54,666\nagrippés à une planche.\n\n10\n00:01:56,416 --\x3e 00:01:58,083\nFui o único sobrevivente (survivant).\n\n11\n00:01:58,666 --\x3e 00:02:01,500\nVocê disse que eram dois.\nO que houve com o outro?\n\n12\n00:02:02,000 --\x3e 00:02:03,791\nAcabou morrendo de insolação (insolation).\n\n13\n00:02:04,291 --\x3e 00:02:05,541\nMas salvou minha vida.\n\n14\n00:02:06,083 --\x3e 00:02:06,958\nEle salgou\n\n15\n00:02:07,791 --\x3e 00:02:08,625\na carne (la viande).\n\n16\n00:02:09,166 --\x3e 00:02:10,250\nTinha um sabor (saveur)\n\n17\n00:02:10,916 --\x3e 00:02:11,833\nque era doce (sucré).\n\n18\n00:02:11,916 --\x3e 00:02:13,458\n<i>Úrsula chorava na mesa</i>\n\n19\n00:02:13,541 --\x3e 00:02:16,708\n<i>comme si elle lisait les lettres</i>\n<i>qui n\'étaient jamais arrivées</i>\n\n20\n00:02:17,458 --\x3e 00:02:22,708\n<i>e nas quais José Arcadio contava</i>\n<i>seus feitos e desventuras…</i>\n\n21\n00:02:22,791 --\x3e 00:02:24,916\nVocê sempre teve um lar (maison) aqui, filho.\n\n22\n00:02:25,666 --\x3e 00:02:27,916\nToute cette nourriture jetée aux cochons…\n\n23\n00:02:35,166 --\x3e 00:02:37,833\nQuando você desapareceu,\nfui atrás de você.\n\n24\n00:02:40,125 --\x3e 00:02:43,583\njusqu\'à ne plus trouver\naucun signe de toi nulle part.\n\n25\n00:02:44,916 --\x3e 00:02:47,125\ne eu não soube mais onde te procurar (recherche).\n\n26\n00:02:52,500 --\x3e 00:02:53,458\nQuem é você?\n\n27\n00:02:54,166 --\x3e 00:02:55,791\nEu me chamo Pietro Crespi.\n\n28\n00:02:55,875 --\x3e 00:02:57,166\nNoivo da Rebeca.\n\n29\n00:02:59,458 --\x3e 00:03:00,541\nE você é?\n\n30\n00:03:01,125 --\x3e 00:03:02,208\nEla é sua irmã.\n\n31\n00:03:10,791 --\x3e 00:03:11,708\nIrmãozinho.\n\n32\n00:03:14,041 --\x3e 00:03:14,958\nJosé Arcadio.\n\n33\n00:03:33,000 --\x3e 00:03:34,125\nPor onde andou?\n\n34\n00:03:36,541 --\x3e 00:03:37,375\nPor aí.\n\n35\n00:03:52,458 --\x3e 00:03:54,916\nQuando me casei,\nme mudei pro segundo andar.\n\n36\n00:04:02,791 --\x3e 00:04:05,625\nE Arcadio dormiu aqui\naté o dia em que saiu de casa.\n\n37\n00:04:06,750 --\x3e 00:04:07,583\nArcadio?\n\n38\n00:04:08,666 --\x3e 00:04:09,500\nO seu filho.\n\n39\n00:04:13,291 --\x3e 00:04:14,416\nEu me lembro…\n\n40\n00:04:16,208 --\x3e 00:04:19,083\nquand tu faisais le mur,\ntu revenais à l\'aube\n\n41\n00:04:19,166 --\x3e 00:04:21,041\net tu me racontais tes aventures.\n\n42\n00:04:26,375 --\x3e 00:04:28,333\nE um dia decidi te perguntar:\n\n43\n00:04:30,833 --\x3e 00:04:33,000\n"O que sentia com isso tudo?"\n\n44\n00:04:36,833 --\x3e 00:04:37,833\nE você disse…\n\n45\n00:04:39,875 --\x3e 00:04:41,583\n"É como um terremoto (tremblement de terre)."\n\n46\n00:04:44,916 --\x3e 00:04:46,625\nTinha razão. Você se lembra?\n\n47\n00:04:48,875 --\x3e 00:04:50,666\nIl suffit que toi, tu te rappelles.\n\n48\n00:04:54,541 --\x3e 00:04:55,833\nVocê se casou?\n\n49\n00:04:59,875 --\x3e 00:05:00,833\nEu me casei\n\n50\n00:05:02,041 --\x3e 00:05:03,416\ne fiquei viúvo (veuf).\n\n51\n00:05:04,208 --\x3e 00:05:05,166\nFim de história.'.split("\n");let n="WEBVTT\n\n",t=0;for(;t<e.length;){for(;t<e.length&&(""===e[t].trim()||/^\d+$/.test(e[t].trim()));)t++;if(t>=e.length)break;const o=e[t].trim();if(!o.includes("--\x3e")){t++;continue}const i=o.match(/(\d{2}:\d{2}:\d{2},\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2},\d{3})/);if(!i){t++;continue}n+=`${i[1].replace(",",".")} --\x3e ${i[2].replace(",",".")}\n`,t++;const l=[];for(;t<e.length&&""!==e[t].trim();)l.push(e[t].trim()),t++;l.length>0&&(n+=l.join("\n")+"\n\n")}return n}();return new Blob([e],{type:"text/vtt"})}();s&&s.size===o.size&&s.type===o.type?console.log("Netflix Subtitle Downloader: No update needed - same blob content"):(console.log("Netflix Subtitle Downloader: Updating subtitle injection - new blob detected"),g(),function(e,o){console.log("Netflix Subtitle Downloader: Adding track element for injection");const i=document.createElement("track");i.id=n,i.src=URL.createObjectURL(o),i.kind="subtitles",i.default=!0,i.srclang="en",e.appendChild(i),i.track.mode="hidden",i.addEventListener("load",function(){console.log("Netflix Subtitle Downloader: Track loaded successfully")},!1);const l=document.createElement("div");l.id=t,l.style.cssText="position: absolute; bottom: 20vh; left: 0; right: 0; color: white; font-size: 3vw; text-align: center; user-select: text; -moz-user-select: text; z-index: 100; pointer-events: none",i.addEventListener("cuechange",function(e){for(;l.firstChild;)l.removeChild(l.firstChild);const n=e.target;if(console.log("Netflix Subtitle Downloader: Active cues:",n.track?.activeCues),n.track?.activeCues)for(const e of n.track.activeCues){const n=document.createElement("div");n.style.cssText="background: rgba(0,0,0,0.8); white-space: pre-wrap; padding: 0.2em 0.3em; margin: 10px auto; width: fit-content; width: -moz-fit-content; pointer-events: auto",n.innerHTML=m(e.text,!0),l.appendChild(n)}},!1);let a=document.querySelector(".watch-video");if(a||(a=document.querySelector('[data-uia="video-player"]')),a||(a=document.querySelector(".VideoPlayer")),a||(a=document.querySelector(".player-container")),a||(a=document.querySelector('[data-testid="video-player"]')),a||(a=document.querySelector(".netflix-player")),!a){const e=document.querySelectorAll('[class*="video"], [class*="player"]');for(const n of e){const e=n.className.toLowerCase();if(!e.includes("billboard")&&!e.includes("trailer")&&!e.includes("preview")){a=n;break}}}if(!a)return console.error("Netflix Subtitle Downloader: Could not find player element to append subtitles to"),void console.log("Netflix Subtitle Downloader: Available video-related elements:",{watchVideo:document.querySelector(".watch-video"),videoPlayer:document.querySelector('[data-uia="video-player"]'),videoPlayerClass:document.querySelector(".VideoPlayer"),playerContainer:document.querySelector(".player-container"),testIdPlayer:document.querySelector('[data-testid="video-player"]'),netflixPlayer:document.querySelector(".netflix-player"),videoElements:document.querySelectorAll('[class*="video"]'),playerElements:document.querySelectorAll('[class*="player"]'),watchElements:document.querySelectorAll('[class*="watch"]')});console.log("Netflix Subtitle Downloader: Found player element:",a),a.appendChild(l),console.log("Netflix Subtitle Downloader: Track element and overlay added successfully")}(e,o),s=o)}else s&&(console.log("Netflix Subtitle Downloader: Cleaning up subtitle injection"),g(),s=null)}console.log("Netflix Subtitle Downloader: Starting JSON hijacking immediately");const v=JSON.stringify;JSON.stringify=function(n){const t=d(n);return t&&(console.log("Netflix Subtitle Downloader: Injecting WebVTT format into request"),t.unshift(e)),v.apply(this,arguments)};const S=JSON.parse;function h(){let e=null;const n=document.querySelector("*[data-videoid]");if(n){const t=n.getAttribute("data-videoid");t&&(e=+t)}a=e,a||(r=null),b()}JSON.parse=function(){const e=S.apply(this,arguments);if(e&&e.result&&e.result.movieId&&e.result.timedtexttracks&&(console.log("Netflix Subtitle Downloader: Captured Netflix API response"),u(e.result)),e&&e.result&&e.result.result&&e.result.result.timedtexttracks&&(console.log("Netflix Subtitle Downloader: Captured alternative Netflix API response"),u(e.result.result)),e&&e.result&&e.result.movies)for(const n in e.result.movies){const t=e.result.movies[n];t&&t.timedtexttracks&&(console.log("Netflix Subtitle Downloader: Captured movies object response"),u(t))}return e},console.log("Netflix Subtitle Downloader: Initializing page script"),window.addEventListener("message",function(e){if("NETFLIX_SUBTITLES_REQUEST"===e.data.type)switch(console.log("Netflix Subtitle Downloader: Received request from content script:",e.data),e.data.action){case"GET_TRACKS":a&&i.has(a)?x({type:"NETFLIX_SUBTITLES",action:"TRACKS_AVAILABLE",data:{movieId:a,tracks:i.get(a)}}):x({type:"NETFLIX_SUBTITLES",action:"NO_TRACKS",data:{message:"No tracks available"}});break;case"DOWNLOAD_SUBTITLE":(async function(e){if(console.log("Netflix Subtitle Downloader: Downloading subtitle for track:",e),!a)throw new Error("No current movie ID");const n=i.get(a);if(!n)throw new Error("No track list found for current movie");const t=n.find(n=>n.id===e);if(!t)throw new Error("Track not found");const o=a+"/"+e;if(!l.has(o)){console.log("Netflix Subtitle Downloader: Fetching WebVTT from:",t.bestUrl);try{const e=await fetch(t.bestUrl);if(!e.ok)throw new Error("Failed to fetch WebVTT file");const n=await e.blob();l.set(o,n),console.log("Netflix Subtitle Downloader: WebVTT cached successfully")}catch(e){throw console.error("Netflix Subtitle Downloader: Error fetching WebVTT:",e),e}}const r=l.get(o),s=await function(e){return new Promise((n,t)=>{const o=document.createElement("video"),i=document.createElement("track");i.kind="subtitles",i.default=!0,o.appendChild(i);const l=URL.createObjectURL(e);i.src=l,i.addEventListener("load",function(){try{const e=[];let t=1;for(const n of i.track.cues){const o=m(n.text,!0);e.push(t+"\n"+p(n.startTime)+" --\x3e "+p(n.endTime)+"\n"+o+"\n\n"),t++}URL.revokeObjectURL(l),o.remove(),n(e.join(""))}catch(e){URL.revokeObjectURL(l),o.remove(),t(e)}},!1),i.addEventListener("error",function(){URL.revokeObjectURL(l),o.remove(),t(new Error("Failed to load WebVTT track"))},!1)})}(r);let c="netflix_subtitle";a&&(c+="_"+a),c+="_"+t.language+".srt";const d=new Blob([s],{type:"text/srt"}),u=URL.createObjectURL(d),f=document.createElement("a");return f.href=u,f.download=c,f.style.display="none",document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(u),console.log("Netflix Subtitle Downloader: Subtitle downloaded:",c),c})(e.data.data.trackId).then(e=>{x({type:"NETFLIX_SUBTITLES",action:"DOWNLOAD_SUCCESS",data:{filename:e}})}).catch(e=>{console.error("Netflix Subtitle Downloader: Download error:",e),x({type:"NETFLIX_SUBTITLES",action:"DOWNLOAD_ERROR",data:{error:e instanceof Error?e.message:"Unknown error"}})})}}),setInterval(h,500),h(),document.body.addEventListener("keydown",function(e){83!==e.keyCode||e.altKey||e.ctrlKey||e.metaKey||(console.log("Netflix Subtitle Downloader: Toggle subtitle display"),c=!c,function(){const e=document.getElementById(t);e&&(e.style.visibility=c?"visible":"hidden")}())},!1),console.log("Netflix Subtitle Downloader: Page script initialized - JSON hijacking and subtitle injection active")}()})();