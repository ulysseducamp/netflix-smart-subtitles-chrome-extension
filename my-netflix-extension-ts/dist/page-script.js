(()=>{"use strict";!function(){console.log("Netflix Subtitle Downloader: Page script loaded - starting JSON hijacking immediately");const e="webvtt-lssdh-ios8",t=["heaac-2-dash","heaac-2hq-dash","playready-h264mpl30-dash","playready-h264mpl31-dash","playready-h264hpl30-dash","playready-h264hpl31-dash","vp9-profile0-L30-dash-cenc","vp9-profile0-L31-dash-cenc","dfxp-ls-sdh","simplesdh","nflx-cmisc","BIF240","BIF320"],o=new Map,n=new Map;let l=null,i=null;function r(e){for(const o in e){const n=e[o];if(Array.isArray(n)&&("profiles"===o||n.some(e=>t.includes(e))))return n;if("object"==typeof n&&null!==n){const e=r(n);if(e)return e}}return null}function a(t){const n=t.movieId;console.log("Netflix Subtitle Downloader: Extracting tracks for movie ID:",n);const l=[];if(t.timedtexttracks){console.log("Netflix Subtitle Downloader: Found timedtexttracks:",t.timedtexttracks);for(const o of t.timedtexttracks){if(console.log("Netflix Subtitle Downloader: Processing track:",o.language),o.isForcedNarrative||o.isNoneTrack){console.log("Netflix Subtitle Downloader: Skipping forced/none track");continue}if(!o.ttDownloadables){console.log("Netflix Subtitle Downloader: No ttDownloadables found");continue}const t=o.ttDownloadables[e];if(console.log("Netflix Subtitle Downloader: WebVTT downloadable:",t),!t||!t.urls){console.log("Netflix Subtitle Downloader: No WebVTT URLs found");continue}const n=t.urls[0].url;if(!n){console.log("Netflix Subtitle Downloader: No valid URL found");continue}const i="closedcaptions"===o.rawTrackType;l.push({id:o.new_track_id,language:o.language,languageDescription:o.languageDescription,bestUrl:n,isClosedCaptions:i})}console.log("Netflix Subtitle Downloader: Caching movie tracks:",n,l),o.set(n,l),u({type:"NETFLIX_SUBTITLES",action:"TRACKS_AVAILABLE",data:{movieId:n,tracks:l}})}else console.log("Netflix Subtitle Downloader: No timedtexttracks found")}const s=RegExp("</?([^>]*)>","ig");function c(e,t=!0){let o=e;if(o=o.replace(s,function(e,t){return["i","u","b"].includes(t.toLowerCase())?e:""}),t){const e=o.split("\n"),t=[];for(const o of e)o.startsWith("&lrm;")?t.push("‪"+o.slice(5)+"‬"):o.startsWith("&rlm;")?t.push("‫"+o.slice(5)+"‬"):t.push(o);o=t.join("\n")}return o}function d(e){const t=new Date(0,0,0,0,0,0,1e3*e);return t.getHours().toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0")+":"+t.getSeconds().toString().padStart(2,"0")+","+t.getMilliseconds().toString().padStart(3,"0")}function u(e){window.postMessage(e,"*")}console.log("Netflix Subtitle Downloader: Starting JSON hijacking immediately");const f=JSON.stringify;JSON.stringify=function(t){const o=r(t);return o&&(console.log("Netflix Subtitle Downloader: Injecting WebVTT format into request"),o.unshift(e)),f.apply(this,arguments)};const g=JSON.parse;function p(){let e=null;const t=document.querySelector("*[data-videoid]");if(t){const o=t.getAttribute("data-videoid");o&&(e=o)}l=e,l||(i=null)}JSON.parse=function(){const e=g.apply(this,arguments);if(e&&e.result&&e.result.movieId&&e.result.timedtexttracks&&(console.log("Netflix Subtitle Downloader: Captured Netflix API response"),a(e.result)),e&&e.result&&e.result.result&&e.result.result.timedtexttracks&&(console.log("Netflix Subtitle Downloader: Captured alternative Netflix API response"),a(e.result.result)),e&&e.result&&e.result.movies)for(const t in e.result.movies){const o=e.result.movies[t];o&&o.timedtexttracks&&(console.log("Netflix Subtitle Downloader: Captured movies object response"),a(o))}return e},console.log("Netflix Subtitle Downloader: Initializing page script"),window.addEventListener("message",function(e){if("NETFLIX_SUBTITLES_REQUEST"===e.data.type)switch(console.log("Netflix Subtitle Downloader: Received request from content script:",e.data),e.data.action){case"GET_TRACKS":l&&o.has(l)?u({type:"NETFLIX_SUBTITLES",action:"TRACKS_AVAILABLE",data:{movieId:l,tracks:o.get(l)}}):u({type:"NETFLIX_SUBTITLES",action:"NO_TRACKS",data:{message:"No tracks available"}});break;case"DOWNLOAD_SUBTITLE":(async function(e){if(console.log("Netflix Subtitle Downloader: Downloading subtitle for track:",e),!l)throw new Error("No current movie ID");const t=o.get(l);if(!t)throw new Error("No track list found for current movie");const i=t.find(t=>t.id===e);if(!i)throw new Error("Track not found");const r=l+"/"+e;if(!n.has(r)){console.log("Netflix Subtitle Downloader: Fetching WebVTT from:",i.bestUrl);try{const e=await fetch(i.bestUrl);if(!e.ok)throw new Error("Failed to fetch WebVTT file");const t=await e.blob();n.set(r,t),console.log("Netflix Subtitle Downloader: WebVTT cached successfully")}catch(e){throw console.error("Netflix Subtitle Downloader: Error fetching WebVTT:",e),e}}const a=n.get(r),s=await function(e){return new Promise((t,o)=>{const n=document.createElement("video"),l=document.createElement("track");l.kind="subtitles",l.default=!0,n.appendChild(l);const i=URL.createObjectURL(e);l.src=i,l.addEventListener("load",function(){try{const e=[];let o=1;for(const t of l.track.cues){const n=c(t.text,!0);e.push(o+"\n"+d(t.startTime)+" --\x3e "+d(t.endTime)+"\n"+n+"\n\n"),o++}URL.revokeObjectURL(i),n.remove(),t(e.join(""))}catch(e){URL.revokeObjectURL(i),n.remove(),o(e)}},!1),l.addEventListener("error",function(){URL.revokeObjectURL(i),n.remove(),o(new Error("Failed to load WebVTT track"))},!1)})}(a);let u="netflix_subtitle";l&&(u+="_"+l),u+="_"+i.language+".srt";const f=new Blob([s],{type:"text/srt"}),g=URL.createObjectURL(f),p=document.createElement("a");return p.href=g,p.download=u,p.style.display="none",document.body.appendChild(p),p.click(),document.body.removeChild(p),URL.revokeObjectURL(g),console.log("Netflix Subtitle Downloader: Subtitle downloaded:",u),u})(e.data.data.trackId).then(e=>{u({type:"NETFLIX_SUBTITLES",action:"DOWNLOAD_SUCCESS",data:{filename:e}})}).catch(e=>{console.error("Netflix Subtitle Downloader: Download error:",e),u({type:"NETFLIX_SUBTITLES",action:"DOWNLOAD_ERROR",data:{error:e instanceof Error?e.message:"Unknown error"}})})}}),setInterval(p,500),p(),console.log("Netflix Subtitle Downloader: Page script initialized - JSON hijacking active")}()})();