(()=>{"use strict";console.log("Netflix Subtitle Downloader: Popup script loaded");const e=document.getElementById("subtitle-select"),t=document.getElementById("download-btn"),o=document.getElementById("status-message");function n(e,t="info"){o.textContent=e,o.className=`status ${t}`,console.log("Netflix Subtitle Downloader: Status:",e)}function i(){e.disabled=!0,t.disabled=!0}function l(o){if(console.log("Netflix Subtitle Downloader: Populating dropdown with tracks:",o),e.innerHTML="",!o||0===o.length)return e.innerHTML='<option value="">No subtitles available</option>',void i();const n=document.createElement("option");n.value="",n.textContent="Select a subtitle...",e.appendChild(n),o.forEach(t=>{const o=document.createElement("option");o.value=t.id,o.textContent=t.languageDescription+(t.isClosedCaptions?" [CC]":""),e.appendChild(o)}),e.disabled=!1,t.disabled=!1,console.log("Netflix Subtitle Downloader: Dropdown populated with",o.length,"tracks")}async function r(){console.log("Netflix Subtitle Downloader: Download button clicked");const t=e.value;if(t){console.log("Netflix Subtitle Downloader: Downloading subtitle track:",t),n("Downloading subtitle...","info");try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e)return void n("No active tab found","error");const o=await chrome.tabs.sendMessage(e.id,{action:"downloadSubtitle",trackId:t});console.log("Netflix Subtitle Downloader: Download response:",o),o&&o.success?n("Download started!","success"):n("Error starting download","error")}catch(e){console.error("Netflix Subtitle Downloader: Error downloading subtitle:",e),n("Error downloading subtitle: "+(e instanceof Error?e.message:"Unknown error"),"error")}}else n("Please select a subtitle first","error")}function s(){console.log("Netflix Subtitle Downloader: Initializing popup..."),i(),o.textContent="",o.className="status",async function(){console.log("Netflix Subtitle Downloader: Checking if on Netflix episode page...");try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e)return void n("No active tab found","error");if(console.log("Netflix Subtitle Downloader: Active tab URL:",e.url),!e.url||!e.url.includes("netflix.com"))return n("Not on Netflix","error"),void i();const t=await chrome.tabs.sendMessage(e.id,{action:"checkNetflixPage"});console.log("Netflix Subtitle Downloader: Content script response:",t),t&&t.success?t.isNetflixEpisode?(n(`Found: ${t.title}`,"success"),await async function(){console.log("Netflix Subtitle Downloader: Loading available subtitles...");try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e)return void n("No active tab found","error");const t=await chrome.tabs.sendMessage(e.id,{action:"getSubtitles"});if(console.log("Netflix Subtitle Downloader: Subtitles response:",t),t&&t.success){const e=t.tracks||[];l(e),e.length>0?n(`Found ${e.length} subtitle track(s)`,"success"):n("No subtitle tracks found","info")}else n("Error loading subtitles","error"),l([])}catch(e){console.error("Netflix Subtitle Downloader: Error loading subtitles:",e),n("Error loading subtitles: "+(e instanceof Error?e.message:"Unknown error"),"error"),l([])}}()):(n(t.message||"Not on Netflix episode page","error"),i()):(n("Error checking Netflix page","error"),i())}catch(e){console.error("Netflix Subtitle Downloader: Error checking Netflix page:",e);const t=e instanceof Error?e.message:"Unknown error";t.includes("Could not establish connection")?n("Please refresh the Netflix page and try again","error"):n("Error: "+t,"error"),i()}}(),t.addEventListener("click",r),e.addEventListener("change",function(){const e=this.value;t.disabled=!e}),console.log("Netflix Subtitle Downloader: Popup initialized")}document.addEventListener("DOMContentLoaded",s),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s()})();